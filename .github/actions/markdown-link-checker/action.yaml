name: Markdown Link Checker
description: Checks all Markdown files for broken links, including relative ones

inputs:
  github-token:
    description: GitHub token (not used, but kept for interface compatibility)
    required: false
  args:
    description: Arguments to pass to markdown-link-check
    required: false
    default: "--quiet --retry"

runs:
  using: "composite"
  steps:
    - name: Install markdown-link-check and jq
      shell: bash
      run: npm install -g markdown-link-check

    - name: Run link check on all Markdown files (with relative resolution)
      shell: bash
      run: |
        set -euo pipefail
        echo "üîç Scanning all Markdown files for broken links..."
        failed=0
        total_dead_links=0

        REPO_REF=$(echo "${GITHUB_REF}" | sed -E 's#refs/heads/##; s#refs/pull/.*/merge#main#')
        REPO_URL="https://github.com/${GITHUB_REPOSITORY}/blob/${REPO_REF}"
        # escaped_repo_url=$(printf '%s\n' "$REPO_URL" | sed 's/[&/\]/\\&/g')

        while IFS= read -r -d '' file; do
          echo "------------------------------------------------------------"
          echo "üìÑ Checking: $file"

          # Create a temp copy with absolute links
          temp_file=$(mktemp)
 
          file_dir=$(dirname "$file")
          awk -v url="$REPO_URL" -v dir="$file_dir" '
          {
            line = $0
            output = ""
            while (match(line, /\[([^\]]+)\]\(([^)]+)\)/, arr)) {
              prefix = substr(line, 1, RSTART - 1)
              suffix = substr(line, RSTART + RLENGTH)
              text = arr[1]
              link = arr[2]

              if (link ~ /^(https?:\/\/|mailto:|#)/) {
                output = output prefix "[" text "](" link ")"
              } else {
                gsub(/^\.\/+/, "", link)
                full_link = url "/" dir "/" link
                gsub(/\/+/, "/", full_link)
                output = output prefix "[" text "](" full_link ")"
              }

              line = suffix
            }
            output = output line
            print output
          }
          ' "$file" > "$temp_file"

        output=$(markdown-link-check ${{ inputs.args }} "$temp_file" 2>&1 || true)
        echo "$output"

        # Show 403s separately
        ignored_403=$(echo "$output" | grep '‚úñ' | grep '‚Üí Status: 403' || true)
        if [ -n "$ignored_403" ]; then
          echo "‚ÑπÔ∏è  Ignored 403 links (not counted as broken):"
          echo "$ignored_403"
        fi

        # Count only broken links that are NOT 403s
        num_file_dead_links=$(echo "$output" | grep '‚úñ' | grep -v '‚Üí Status: 403' | wc -l)

        if [ "$num_file_dead_links" -gt 0 ]; then
          echo "‚ùå $num_file_dead_links broken (non-403) links in $file"
          total_dead_links=$((total_dead_links + num_file_dead_links))
          failed=1
        else
          echo "‚úÖ No broken (non-403) links in $file"
        fi